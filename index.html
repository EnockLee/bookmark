<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>书签导航</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    #controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    #search-input, #filter-category { padding: 8px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc; }
    
    #bookmark-columns { display: flex; gap: 12px; }
    .bookmark-column { list-style: none; padding: 0; flex: 1; min-width: 120px; }
    .bookmark-column li { 
      background: white; padding: 10px; border-radius: 8px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
      display: flex; align-items: center; gap: 8px;
      min-height: 40px; 
    }
    li img.favicon { width: 16px; height: 16px; flex-shrink: 0; }
    li a { text-decoration: none; color: #333; font-weight: bold; flex-grow: 1; text-align: left; }
    li small { color: #666; font-size: 12px; }
    .column-header { font-weight: bold; margin-bottom: 8px; text-align: center; }
  </style>
</head>
<body>

<div id="controls">
  <input id="search-input" type="text" placeholder="搜索书签..." oninput="renderBookmarks()">
  <select id="filter-category" onchange="renderBookmarks()">
    <option value="">全部分类</option>
  </select>
</div>

<div id="bookmark-columns"></div>

<script>
let allBookmarks = [];

async function loadBookmarks() {
  try {
    const res = await fetch("bookmarks.json");  
    allBookmarks = await res.json();
    initCategories();
    renderBookmarks();
  } catch (err) {
    console.error("加载书签失败：", err);
  }
}

function initCategories() {
  const select = document.getElementById("filter-category");
  select.length = 1;
  const categories = [...new Set(allBookmarks.map(b => b.category).filter(Boolean))].sort();
  categories.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    select.appendChild(opt);
  });
}

function getFavicon(url) {
  const googleFavicon = `https://www.google.com/s2/favicons?sz=32&domain_url=${url}`;
  const siteFavicon = new URL('/favicon.ico', url).href;
  const defaultFavicon = 'icons/default.png';

  const img = document.createElement("img");
  img.className = "favicon";
  img.src = googleFavicon;

  img.onerror = () => {
    img.onerror = () => { img.src = defaultFavicon; };
    img.src = siteFavicon;
  };
  img.onload = () => {
    if (!img.naturalWidth || !img.naturalHeight) {
      img.src = defaultFavicon;
    }
  };
  return img;
}

// 按分类分组
function groupByCategory(data) {
  const map = {};
  data.forEach(b => {
    if (!map[b.category]) map[b.category] = [];
    map[b.category].push(b);
  });
  return map;
}

function renderBookmarks() {
  const container = document.getElementById("bookmark-columns");
  const search = document.getElementById("search-input").value.toLowerCase();
  const filterCategory = document.getElementById("filter-category").value;

  container.innerHTML = "";

  // 筛选书签
  let filtered = allBookmarks.filter(b =>
    (!filterCategory || b.category === filterCategory) &&
    (!search || b.name.toLowerCase().includes(search) || b.url.toLowerCase().includes(search))
  );

  const grouped = groupByCategory(filtered);
  let categories = Object.keys(grouped).sort();

  // 不足 8 列 → 填充空列
  while (categories.length < 8) categories.push("__EMPTY__" + categories.length);

  // 每列生成 ul
  categories.forEach(cat => {
    const ul = document.createElement("ul");
    ul.className = "bookmark-column";

    // 列头显示分类名
    const header = document.createElement("div");
    header.className = "column-header";
    header.textContent = cat.startsWith("__EMPTY__") ? "" : cat;
    ul.appendChild(header);

    if (grouped[cat]) {
      grouped[cat].forEach(b => {
        const li = document.createElement("li");
        li.appendChild(getFavicon(b.url));
        const link = document.createElement("a");
        link.href = b.url;
        link.target = "_blank";
        link.textContent = b.name;
        li.appendChild(link);

        const small = document.createElement("small");
        small.textContent = `[${b.category}]`;
        li.appendChild(small);

        ul.appendChild(li);
      });
    }

    container.appendChild(ul);
  });
}

loadBookmarks();
</script>
</body>
</html>
